name: SFM CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # ---------------- CHECKOUT ----------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # ---------------- NODE SETUP ----------------
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # ---------------- FRONTEND INSTALL ----------------
      - name: Install Frontend Dependencies
        shell: powershell
        run: |
          cd sfm_ui
          npm install

      # ---------------- FRONTEND BUILD ----------------
      - name: Build Frontend
        shell: powershell
        run: |
          cd sfm_ui
          npm run build

      # ---------------- BACKEND INSTALL ----------------
      - name: Install Backend Dependencies
        shell: powershell
        run: |
          cd sfm_api
          npm install

      # ---------------- INSTALL PM2 ----------------
      - name: Install PM2
        shell: powershell
        run: npm install -g pm2

      # ---------------- PM2 BACKEND DEPLOY ----------------
      - name: Restart Backend using PM2
        shell: powershell
        continue-on-error: true
        run: |
          cd sfm_api

          # PM2 folder fix for windows
          $env:PM2_HOME="D:\etc\.pm2"

          Write-Host "Stopping old PM2 app..."
          pm2 stop sfm-api 2>$null

          Write-Host "Deleting old PM2 app..."
          pm2 delete sfm-api 2>$null

          Write-Host "Starting backend..."
          pm2 start server.js --name sfm-api

          pm2 save

      # ---------------- DEPLOY FRONTEND TO NGINX ----------------
      - name: Deploy Frontend to NGINX
        shell: powershell
        continue-on-error: true
        run: |
          $nginxExe = "D:\nginx\nginx.exe"

          Write-Host "Stopping NGINX..."
          & $nginxExe -p "D:\nginx" -s stop 2>$null

          Start-Sleep -Seconds 2

          $htmlPath = "D:\nginx\html"
          $distPath = "D:\actions-runner\_work\sfm\sfm\sfm_ui\dist"

          Write-Host "Copying frontend build to NGINX..."
          if (!(Test-Path $htmlPath)) {
            New-Item -ItemType Directory -Path $htmlPath -Force
          }

          robocopy $distPath $htmlPath /E /NFL /NDL

      # ---------------- START NGINX ----------------
      - name: Restart NGINX
        shell: powershell
        run: |
          try {
            Start-Process "D:\nginx\nginx.exe" -ArgumentList '-p "D:\nginx" -c "conf\nginx.conf"' -NoNewWindow
            Write-Host "NGINX Started Successfully"
          } catch {
            Write-Host "Failed to start NGINX"
          }
