name: SFM CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # ---------------- Checkout Code ----------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # ---------------- Node Setup ----------------
      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # ---------------- Frontend ----------------
      - name: Install Frontend Dependencies
        run: |
          cd sfm_ui
          npm install
        shell: powershell

      - name: Build Frontend
        run: |
          cd sfm_ui
          npm run build
        shell: powershell

      # ---------------- Backend ----------------
      - name: Install Backend Dependencies
        run: |
          cd sfm_api
          npm install
        shell: powershell

      - name: Install PM2
        run: npm install -g pm2
        shell: powershell

      - name: Start Backend With PM2
        run: |
          cd sfm_api

          # PM2 HOME (must match same location everywhere)
          $env:PM2_HOME="D:\etc\.pm2"

          # Stop & delete previous instance safely
          pm2 stop sfm-api -s 2>$null
          pm2 delete sfm-api -s 2>$null

          # Start backend
          pm2 start server.js --name sfm-api
          pm2 save
        shell: powershell

      # ---------------- NGINX Deployment ----------------
      - name: Deploy Frontend to NGINX
        run: |
          # SAFELY STOP NGINX (no admin required)
          $nginxExe = "D:\nginx\nginx.exe"
          if (Test-Path $nginxExe) {
              & $nginxExe -p "D:\nginx" -s stop
          }
          Start-Sleep -Seconds 3

          # Remove old html folder
          $htmlPath = "D:\nginx\html"
          if (Test-Path $htmlPath) {
              try { Remove-Item -Recurse -Force -ErrorAction Stop $htmlPath }
              catch { Write-Host "Folder still in use. Skipping removal..." }
          }

          # Recreate folder
          if (!(Test-Path $htmlPath)) {
              New-Item -ItemType Directory -Path $htmlPath -Force
          }

          # Copy frontend build
          $source = "D:\actions-runner\_work\sfm\sfm\sfm_ui\dist"
          robocopy $source $htmlPath /E /NFL /NDL /NJH /NJS /nc /ns /np
        shell: powershell

      - name: Restart NGINX
        run: |
          Start-Process "D:\nginx\nginx.exe" -ArgumentList '-p "D:\nginx" -c "conf\nginx.conf"' -NoNewWindow
        shell: powershell
