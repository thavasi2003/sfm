name: SFM CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # ---------------- Frontend ----------------
      - name: Install Frontend Dependencies
        shell: powershell
        run: |
          cd sfm_ui
          npm install

      - name: Build Frontend
        shell: powershell
        run: |
          cd sfm_ui
          npm run build

      # ---------------- Backend ----------------
      - name: Install Backend Dependencies
        shell: powershell
        run: |
          cd sfm_api
          npm install

      - name: Install PM2
        shell: powershell
        run: npm install -g pm2

      # ---------------- PM2 START ----------------
      # ---------------- PM2 START ----------------
      - name: Start Backend with PM2
        shell: powershell
        continue-on-error: true
        run: |
          cd sfm_api
          $env:PM2_HOME="D:\etc\.pm2"
      
          # Show pm2 path
          Get-Command pm2
      
          Write-Host "Stopping old PM2 process..."
          try {
              pm2 stop sfm-api
          } catch {
              Write-Host "Process not running"
          }
      
          Write-Host "Deleting old PM2 process..."
          try {
              pm2 delete sfm-api
          } catch {
              Write-Host "Process not found"
          }
      
          Write-Host "Starting app with PM2..."
          pm2 start server.js --name sfm-api
      
          Write-Host "Saving PM2 process list..."
          pm2 save
      # ---------------- Deploy Frontend to NGINX ----------------
      - name: Deploy Frontend to NGINX
        shell: powershell
        continue-on-error: true
        run: |
          $nginx = "D:\nginx\nginx.exe"
      
          Write-Host "Checking NGINX..."
      
          if (Test-Path $nginx) {
              try {
                  & $nginx -p "D:\nginx" -s stop
                  Write-Host "NGINX stopped"
              } catch {
                  Write-Host "NGINX was not running"
              }
          }
      
          Start-Sleep -Seconds 2
      
          $htmlPath = "D:\nginx\html"
      
          if (Test-Path $htmlPath) {
              try {
                  Remove-Item "$htmlPath\*" -Recurse -Force
              } catch {
                  Write-Host "Files locked, skipping delete"
              }
          } else {
              New-Item -ItemType Directory -Path $htmlPath -Force
          }
      
          $source = "D:\actions-runner\_work\sfm\sfm\sfm_ui\dist"
          robocopy $source $htmlPath /E /NFL /NDL
      
      # ---------------- Restart NGINX ----------------
      - name: Restart NGINX
        shell: powershell
        continue-on-error: true
        run: |
          try {
              Start-Process "D:\nginx\nginx.exe" -ArgumentList '-p "D:\nginx" -c "conf\nginx.conf"' -NoNewWindow
              Write-Host "NGINX started"
          } catch {
              Write-Host "Failed to start NGINX"
          }

